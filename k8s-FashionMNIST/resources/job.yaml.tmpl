apiVersion: v1
kind: ConfigMap
metadata:
  name: training-script
data:
  train.py: |
<<<TRAINING_SCRIPT>>>
---
apiVersion: batch/v1
kind: Job
metadata:
  name: gpu-training-job
spec:
  template:
    spec:
      # Use the correct GKE label found in the node's YAML output
      nodeSelector:
        cloud.google.com/gke-accelerator: nvidia-l4
      containers:
      - name: training-container
        image: pytorch/pytorch:2.0.1-cuda11.7-cudnn8-runtime
        command: ["python", "/script/train.py"]
        volumeMounts:
        - name: training-script-volume
          mountPath: /script
        resources:
          limits:
            nvidia.com/gpu: 1
      volumes:
      - name: training-script-volume
        configMap:
          name: training-script
      restartPolicy: OnFailure
  backoffLimit: 4